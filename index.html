<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chuẩn hoá bài viết sản phẩm • Team Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ color-scheme: light dark; }
    body{ font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    textarea{ tab-size: 2; }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900 dark:bg-neutral-950 dark:text-neutral-100">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex items-center justify-between gap-4 mb-5">
      <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">Chuẩn hoá bài viết sản phẩm</h1>
      <div class="flex items-center gap-2">
        <select id="model" class="rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 text-sm">
          <option value="gpt-5">gpt-5 (chuẩn)</option>
          <option value="gpt-5-mini">gpt-5-mini (nhanh/tiết kiệm)</option>
        </select>
        <input id="temperature" type="number" min="0" max="2" step="0.1" value="0.5" class="w-24 rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 text-sm" title="Nhiệt độ (0–2)">
        <button id="generateBtn" class="inline-flex items-center gap-2 rounded-2xl bg-neutral-900 text-white dark:bg-white dark:text-neutral-900 px-4 py-2 text-sm font-medium shadow hover:opacity-90 active:scale-[0.99]">
          Tạo bài viết
        </button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
      <!-- Phần 1 -->
      <section class="col-span-1">
        <div class="rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 shadow-sm">
          <div class="p-4 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
            <h2 class="font-semibold">1) Thông tin sản phẩm (đầu vào)</h2>
            <div class="text-xs text-neutral-500" id="len1">0 ký tự</div>
          </div>
          <div class="p-4">
            <textarea id="inputInfo" rows="18" placeholder="Nhập: mô tả sản phẩm, giá, kích thước, vật liệu, màu sắc, phụ kiện, phương thức đặt hàng, thời gian phát hành, chính sách đổi trả, lưu ý vận chuyển…" class="w-full resize-y rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-950 p-3"></textarea>
            <div class="mt-3 flex gap-2">
              <button data-copy="inputInfo" class="copyBtn rounded-xl px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-700">Copy</button>
              <button data-clear="inputInfo" class="clearBtn rounded-xl px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-700">Xoá</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Phần 2 -->
      <section class="col-span-1">
        <div class="rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 shadow-sm">
          <div class="p-4 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
            <h2 class="font-semibold">2) Template tiêu chuẩn (quy chuẩn viết)</h2>
            <div class="text-xs text-neutral-500" id="len2">0 ký tự</div>
          </div>
          <div class="p-4">
            <textarea id="template" rows="18" class="w-full resize-y rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-950 p-3"></textarea>
            <div class="mt-3 flex flex-wrap gap-2">
              <button id="useSample" class="rounded-xl px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-700">Chèn mẫu</button>
              <button id="saveTemplate" class="rounded-xl px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-700">Lưu template (trình duyệt)</button>
              <button id="loadTemplate" class="rounded-xl px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-700">Tải template đã lưu</button>
              <button data-copy="template" class="copyBtn rounded-xl px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-700">Copy</button>
              <button data-clear="template" class="clearBtn rounded-xl px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-700">Xoá</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Phần 3 -->
      <section class="col-span-1">
        <div class="rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 shadow-sm">
          <div class="p-4 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
            <h2 class="font-semibold">3) Bài viết đã chuẩn hoá (kết quả)</h2>
            <div class="text-xs text-neutral-500" id="len3">0 ký tự</div>
          </div>
          <div class="p-4">
            <textarea id="output" rows="18" class="w-full resize-y rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-950 p-3" placeholder="Kết quả sẽ hiển thị ở đây…"></textarea>
            <div class="mt-3 flex gap-2">
              <button data-copy="output" class="copyBtn rounded-xl px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-700">Copy</button>
              <button data-clear="output" class="clearBtn rounded-xl px-3 py-2 text-sm border border-neutral-300 dark:border-neutral-700">Xoá</button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="mt-6 text-xs text-neutral-500">
      Lưu ý: Để dùng không cần đăng nhập tài khoản, <b>bạn phải chạy một server backend</b> giữ bí mật API Key và gọi OpenAI API hộ trang này.
    </footer>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const inputInfo = el('inputInfo');
    const template = el('template');
    const output = el('output');
    const len1 = el('len1');
    const len2 = el('len2');
    const len3 = el('len3');

    function updateLen(){
      len1.textContent = `${inputInfo.value.length} ký tự`;
      len2.textContent = `${template.value.length} ký tự`;
      len3.textContent = `${output.value.length} ký tự`;
    }
    ['input','change'].forEach(evt=>{
      inputInfo.addEventListener(evt, updateLen);
      template.addEventListener(evt, updateLen);
      output.addEventListener(evt, updateLen);
    });
    updateLen();

    document.querySelectorAll('.copyBtn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const target = el(btn.dataset.copy);
        await navigator.clipboard.writeText(target.value || '');
        btn.textContent = 'Đã copy';
        setTimeout(()=>btn.textContent='Copy', 1200);
      });
    });

    document.querySelectorAll('.clearBtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        el(btn.dataset.clear).value = '';
        updateLen();
      });
    });

    el('useSample').addEventListener('click', ()=>{
      template.value = `# Tiêu đề: **{Tên sản phẩm}**

## Điểm nổi bật
- 3–5 bullet quan trọng (vật liệu, hoàn thiện, tính năng).
- Nếu có phiên bản/biến thể: nêu rõ khác biệt.

## Thông số
- Kích thước (D x R x C), trọng lượng, chất liệu, màu sắc.
- Phụ kiện kèm theo.

## Giá & phát hành
- Giá niêm yết, chương trình ưu đãi (nếu có).
- Thời gian phát hành / dự kiến về hàng.

## Đặt hàng
- Cọc bao nhiêu, phương thức thanh toán, thời gian xử lý.
- Giao hàng: phương thức, phí, lưu ý đóng gói/hàng dễ vỡ.

## Chính sách
- Đổi trả, bảo hành, điều kiện áp dụng.

> Lưu ý định dạng: 
> - Dùng tiêu đề cấp 1–3, bold cho mục quan trọng.
> - Số đo dùng cùng đơn vị; tiền tệ ghi VND (hoặc quy đổi). 
> - Văn phong rõ ràng, ngắn gọn, không phóng đại.`;
      updateLen();
    });

    el('saveTemplate').addEventListener('click', ()=>{
      localStorage.setItem('product_template_v1', template.value || '');
      alert('Đã lưu template vào trình duyệt.');
    });
    el('loadTemplate').addEventListener('click', ()=>{
      template.value = localStorage.getItem('product_template_v1') || '';
      updateLen();
    });

    async function generate(){
      const model = el('model').value;
      const temperature = parseFloat(el('temperature').value || '0.5');
      const payload = { model, temperature, productInfo: inputInfo.value, template: template.value };
      output.value = '';
      updateLen();
      el('generateBtn').disabled = true; el('generateBtn').textContent = 'Đang tạo…';
      try{
        const res = await fetch('/api/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if(!res.ok) throw new Error(await res.text());
        // hỗ trợ cả streaming (text/event-stream) lẫn JSON thường
        const ct = res.headers.get('content-type') || '';
        if(ct.includes('text/event-stream')){
          const reader = res.body.getReader();
          const decoder = new TextDecoder('utf-8');
          while(true){
            const {value, done} = await reader.read();
            if(done) break;
            const chunk = decoder.decode(value, {stream:true});
            for(const line of chunk.split('\n')){
              if(line.startsWith('data: ')){
                const data = line.slice(6);
                if(data === '[DONE]') break;
                try {
                  const obj = JSON.parse(data);
                  if(obj.delta) { output.value += obj.delta; updateLen(); }
                } catch {}
              }
            }
          }
        } else {
          const json = await res.json();
          output.value = json.text || '';
          updateLen();
        }
      } catch(err){
        output.value = 'Lỗi: ' + (err?.message || String(err));
        updateLen();
      } finally {
        el('generateBtn').disabled = false; el('generateBtn').textContent = 'Tạo bài viết';
      }
    }

    el('generateBtn').addEventListener('click', generate);
  </script>
</body>
</html>
